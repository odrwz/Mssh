#!/usr/bin/env bash
# mssh -- SSH Host & Key Manager
# Requirements: bash, ssh-keygen, awk, grep, sed (all macOS built-in)
# https://github.com/odrwz/mssh

set -uo pipefail

SSH_CONFIG="$HOME/.ssh/config"

# --- Helpers ----------------------------------------------------------------

_ensure_config() {
  mkdir -p "$HOME/.ssh" && chmod 700 "$HOME/.ssh"
  [[ ! -f "$SSH_CONFIG" ]] && touch "$SSH_CONFIG" && chmod 600 "$SSH_CONFIG"
}

_print_host() {
  local alias=$1 hostname=$2 user=$3 port=${4:-22} idf=${5:-(none)}
  printf "\n  Alias   : %s\n  Host    : %s\n  User    : %s\n  Port    : %s\n  Key     : %s\n\n" \
    "$alias" "$hostname" "$user" "$port" "$idf"
}

# --- SSH Config CRUD --------------------------------------------------------

# Output: one line per host -> alias|hostname|user|port|identityfile
list_hosts() {
  [[ ! -f "$SSH_CONFIG" ]] && return
  awk '
    /^Host / && $2 != "*" {
      if (alias != "") print alias "|" hostname "|" user "|" (port==""?"22":port) "|" idf
      alias=$2; hostname=""; user=""; port=""; idf=""
    }
    /^[[:space:]]+HostName /     { hostname=$2 }
    /^[[:space:]]+User /         { user=$2 }
    /^[[:space:]]+Port /         { port=$2 }
    /^[[:space:]]+IdentityFile / { idf=$2 }
    END { if (alias != "") print alias "|" hostname "|" user "|" (port==""?"22":port) "|" idf }
  ' "$SSH_CONFIG"
}

add_host() {
  local alias=$1 hostname=$2 user=$3 port=${4:-22} idf=${5:-}
  _ensure_config
  {
    printf "\nHost %s\n" "$alias"
    [[ -n "$hostname" ]] && printf "  HostName %s\n" "$hostname"
    [[ -n "$user" ]]     && printf "  User %s\n"     "$user"
    [[ "$port" != "22" && -n "$port" ]] && printf "  Port %s\n" "$port"
    [[ -n "$idf" ]]      && printf "  IdentityFile %s\n" "$idf"
  } >> "$SSH_CONFIG"
}

delete_host() {
  local alias=$1
  awk -v target="Host $alias" '
    /^Host / { skip = ($0 == target) }
    !skip
  ' "$SSH_CONFIG" > /tmp/_climssh_cfg && mv /tmp/_climssh_cfg "$SSH_CONFIG"
}

# --- SSH Keys ---------------------------------------------------------------

list_keys() {
  local found=0
  for f in "$HOME/.ssh"/*; do
    [[ -f "$f" && -f "${f}.pub" ]] && echo "$f" && found=1
  done
  return $(( found == 0 ))
}

do_generate_key() {
  echo ""
  echo "  Key Type:"
  echo "  1) ed25519  (recommended)"
  echo "  2) rsa"
  echo "  3) ecdsa"
  read -rp "  Select [1]: " t
  t=${t:-1}

  local key_type bits=()
  case $t in
    2) key_type="rsa"
       echo "  Bits: 1) 2048  2) 3072  3) 4096"
       read -rp "  Select [3]: " b; b=${b:-3}
       case $b in 1) bits=(-b 2048);; 2) bits=(-b 3072);; *) bits=(-b 4096);; esac ;;
    3) key_type="ecdsa"
       echo "  Curve: 1) 256  2) 384  3) 521"
       read -rp "  Select [1]: " b; b=${b:-1}
       case $b in 2) bits=(-b 384);; 3) bits=(-b 521);; *) bits=(-b 256);; esac ;;
    *) key_type="ed25519" ;;
  esac

  read -rp "  Comment (optional): " comment
  read -rp "  Filename [id_${key_type}]: " filename
  filename=${filename:-id_${key_type}}
  local filepath="$HOME/.ssh/$filename"

  if [[ -f "$filepath" ]]; then
    echo "  File already exists: $filepath"
    echo "  Delete it first or choose a different name."
    return 1
  fi

  local args=(-t "$key_type" -f "$filepath" -q -N "" "${bits[@]}")
  [[ -n "$comment" ]] && args+=(-C "$comment")

  ssh-keygen "${args[@]}" && echo "  Key generated: $filepath"
  echo "$filepath"
}

# --- Menus ------------------------------------------------------------------

menu_manage_hosts() {
  while true; do
    local rows=()
    while IFS= read -r line; do
      rows+=("$line")
    done < <(list_hosts)
    if [[ ${#rows[@]} -eq 0 ]]; then
      echo "  No SSH hosts found in ~/.ssh/config."
      return
    fi

    echo ""
    echo "  -- SSH Hosts ------------------------------------------"
    local i=1
    for row in "${rows[@]}"; do
      IFS='|' read -r alias hostname user port idf <<< "$row"
      printf "  %2d) %-18s %s@%s:%s\n" "$i" "$alias" "${user:--}" "$hostname" "$port"
      (( i++ ))
    done
    echo "   q) <- Back"
    read -rp "  Select (number/q): " sel
    [[ -z "$sel" || "$sel" == "q" ]] && return

    local idx=$(( sel - 1 ))
    if (( idx < 0 || idx >= ${#rows[@]} )); then
      echo "  Invalid selection."; continue
    fi

    IFS='|' read -r alias hostname user port idf <<< "${rows[$idx]}"
    menu_one_host "$alias" "$hostname" "$user" "$port" "$idf"
  done
}

menu_one_host() {
  local h_alias=$1 h_hostname=$2 h_user=$3 h_port=$4 h_idf=$5
  while true; do
    _print_host "$h_alias" "$h_hostname" "$h_user" "$h_port" "$h_idf"
    echo "  1) Edit   2) Delete   q) <- Back"
    read -rp "  Action (1-2/q): " act
    case $act in
      1)
        local orig_alias=$h_alias
        echo ""
        read -rp "  Alias        [$h_alias]:    " v; h_alias=${v:-$h_alias}
        read -rp "  HostName     [$h_hostname]: " v; h_hostname=${v:-$h_hostname}
        read -rp "  User         [$h_user]:     " v; h_user=${v:-$h_user}
        read -rp "  Port         [${h_port:-22}]: " v; h_port=${v:-${h_port:-22}}
        
        # IdentityFile 选择列表
        echo ""
        echo "  IdentityFile [$h_idf]:"
        echo "  0) Keep current"
        echo "  1) Select from existing keys"
        echo "  2) Clear (remove key)"
        read -rp "  Choose [0]: " idf_opt
        idf_opt=${idf_opt:-0}
        case $idf_opt in
          1)
            local keys=()
            while IFS= read -r line; do
              keys+=("$line")
            done < <(list_keys 2>/dev/null || true)
            if [[ ${#keys[@]} -eq 0 ]]; then
              echo "  No existing keys found. Keeping current."
            else
              echo ""
              local i=1
              for k in "${keys[@]}"; do printf "  %d) %s\n" "$i" "$k"; (( i++ )); done
              echo "  q) Cancel"
              read -rp "  Select key: " ksel
              if [[ "$ksel" != "q" && "$ksel" != "Q" && -n "$ksel" ]]; then
                local idx=$(( ksel - 1 ))
                if (( idx >= 0 && idx < ${#keys[@]} )); then
                  h_idf="${keys[$idx]}"
                fi
              fi
            fi ;;
          2) h_idf="" ;;
        esac
        
        delete_host "$orig_alias"
        add_host "$h_alias" "$h_hostname" "$h_user" "$h_port" "$h_idf"
        echo "  Host updated."
        return ;;
      2)
        read -rp "  Delete [$h_alias]? (y/N): " confirm
        if [[ "$confirm" == [Yy] ]]; then
          delete_host "$h_alias"
          echo "  Host deleted."
          return
        fi ;;
      q|Q|"") return ;;
    esac
  done
}

menu_new_host() {
  local h_alias="" h_hostname="" h_user="" h_port="22" h_idf=""
  
  # 第一步：输入基本信息
  echo ""
  read -rp "  Alias   : " h_alias
  [[ -z "$h_alias" ]] && echo "  Cancelled." && return

  read -rp "  Host    : " h_hostname
  [[ -z "$h_hostname" ]] && echo "  Cancelled." && return

  read -rp "  User    : " h_user
  read -rp "  Port    : " h_port; h_port=${h_port:-22}

  # 第二步：选择密钥（内联）
  echo ""
  echo "  IdentityFile (SSH Key):"
  echo "  1) Select Existing Key"
  echo "  2) Generate New Key"
  echo "  3) Skip"
  read -rp "  Choose: " key_opt

  case $key_opt in
    1)
      local keys=()
      while IFS= read -r line; do
        keys+=("$line")
      done < <(list_keys 2>/dev/null || true)
      if [[ ${#keys[@]} -eq 0 ]]; then
        echo "  No existing keys found in ~/.ssh/."
      else
        echo ""
        local i=1
        for k in "${keys[@]}"; do printf "  %d) %s\n" "$i" "$k"; (( i++ )); done
        read -rp "  Select key: " ksel
        h_idf="${keys[$(( ksel - 1 ))]:-}"
      fi ;;
    2)
      h_idf=$(do_generate_key | tail -1) ;;
  esac
  
  # 第三步：确认/编辑循环
  while true; do
    _print_host "$h_alias" "$h_hostname" "$h_user" "$h_port" "$h_idf"
    echo "  1) Confirm and Save"
    echo "  2) Edit..."
    echo "  q) Cancel"
    read -rp "  Choose (1-2/q): " confirm_opt
    
    case $confirm_opt in
      1)
        add_host "$h_alias" "$h_hostname" "$h_user" "$h_port" "$h_idf"
        echo "  Host [$h_alias] added to ~/.ssh/config."
        return ;;
      2)
        # 编辑字段（内联）
        echo ""
        echo "  Select field to edit:"
        echo "  1) Alias       [$h_alias]"
        echo "  2) HostName    [$h_hostname]"
        echo "  3) User        [$h_user]"
        echo "  4) Port        [$h_port]"
        echo "  5) IdentityFile [${h_idf:-(none)}]"
        echo "  q) Back"
        read -rp "  Choose: " field
        
        case $field in
          1)
            read -rp "  Alias [$h_alias]: " v
            h_alias=${v:-$h_alias} ;;
          2)
            read -rp "  HostName [$h_hostname]: " v
            h_hostname=${v:-$h_hostname} ;;
          3)
            read -rp "  User [$h_user]: " v
            h_user=${v:-$h_user} ;;
          4)
            read -rp "  Port [$h_port]: " v
            h_port=${v:-$h_port} ;;
          5)
            # 重新选择密钥（内联）
            echo ""
            echo "  IdentityFile (SSH Key):"
            echo "  1) Select Existing Key"
            echo "  2) Generate New Key"
            echo "  3) Clear"
            echo "  4) Keep current"
            read -rp "  Choose: " key_opt2
            case $key_opt2 in
              1)
                local keys2=()
                while IFS= read -r line; do
                  keys2+=("$line")
                done < <(list_keys 2>/dev/null || true)
                if [[ ${#keys2[@]} -eq 0 ]]; then
                  echo "  No existing keys found."
                else
                  echo ""
                  local i=1
                  for k in "${keys2[@]}"; do printf "  %d) %s\n" "$i" "$k"; (( i++ )); done
                  read -rp "  Select key: " ksel2
                  h_idf="${keys2[$(( ksel2 - 1 ))]:-}"
                fi ;;
              2) h_idf=$(do_generate_key | tail -1) ;;
              3) h_idf="" ;;
            esac ;;
        esac
        ;;
      q|Q|"")
        echo "  Cancelled."
        return ;;
    esac
  done
}

menu_manage_keys() {
  while true; do
    echo ""
    echo "  -- Key Management -------------------------------------"
    echo "  1) List Keys"
    echo "  2) Generate New Key"
    echo "  q) <- Back"
    read -rp "  Select (1-3/q): " opt
    case $opt in
      1)
        echo ""
        local keys=()
        while IFS= read -r line; do
          keys+=("$line")
        done < <(list_keys 2>/dev/null || true)
        if [[ ${#keys[@]} -eq 0 ]]; then
          echo "  No SSH private keys found in ~/.ssh/."
        else
          echo "  SSH Private Keys:"
          for k in "${keys[@]}"; do echo "    * $k"; done
        fi ;;
      2) do_generate_key ;;
      q|Q|"") return ;;
    esac
  done
}

# --- Entry Point ------------------------------------------------------------

main() {
  echo "╔══════════════════════════════════════╗"
  echo "║    mssh -- SSH Host & Key Manager    ║"
  echo "╚══════════════════════════════════════╝"

  while true; do
    echo ""
    echo "  1) Manage SSH Hosts"
    echo "  2) New SSH Host"
    echo "  3) Manage SSH Keys"
    echo "  q) Exit"
    read -rp "  Select (1-3/q): " opt
    case $opt in
      1) menu_manage_hosts ;;
      2) menu_new_host ;;
      3) menu_manage_keys ;;
      q|Q|"") echo "  Goodbye!"; exit 0 ;;
    esac
  done
}

main
